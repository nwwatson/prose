<% content_for(:title, "Growth — #{site_name}") %>

<div>
  <h1 class="text-2xl font-bold text-gray-900">Subscriber Growth</h1>
  <p class="mt-2 text-sm text-gray-600">Track how your audience is growing over time.</p>
</div>

<%# Stat Cards %>
<div class="mt-8 grid grid-cols-1 gap-5 sm:grid-cols-3">
  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="p-5">
      <div class="text-sm font-medium text-gray-500 truncate">Total Subscribers</div>
      <div class="mt-1 text-3xl font-semibold text-gray-900"><%= @total_subscribers %></div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="p-5">
      <div class="text-sm font-medium text-gray-500 truncate">New Subscribers (<%= @range %>)</div>
      <div class="mt-1 text-3xl font-semibold text-gray-900"><%= @new_subscribers %></div>
    </div>
  </div>

  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="p-5">
      <div class="text-sm font-medium text-gray-500 truncate">Latest Post Subscribers</div>
      <% if @latest_post_data %>
        <div class="mt-1 text-3xl font-semibold text-gray-900"><%= @latest_post_data[:count] %></div>
        <p class="mt-1 text-xs text-gray-500 truncate"><%= @latest_post_data[:post].title %></p>
      <% else %>
        <div class="mt-1 text-3xl font-semibold text-gray-900">—</div>
      <% end %>
    </div>
  </div>
</div>

<%# Bar Chart %>
<div class="mt-8 bg-white shadow rounded-lg p-6"
     data-controller="growth-chart"
     data-growth-chart-monthly-value="<%= @monthly_data.to_json %>"
     data-growth-chart-cumulative-value="<%= @cumulative_data.to_json %>">

  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h2 class="text-lg font-medium text-gray-900">Subscriber Growth</h2>

    <div class="flex items-center gap-4">
      <%# Chart mode toggle %>
      <div class="inline-flex rounded-md shadow-sm">
        <button type="button"
                data-growth-chart-target="monthlyBtn"
                data-action="growth-chart#showMonthly"
                class="rounded-l-md bg-indigo-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-indigo-700">
          Monthly
        </button>
        <button type="button"
                data-growth-chart-target="cumulativeBtn"
                data-action="growth-chart#showCumulative"
                class="-ml-px rounded-r-md bg-white px-3 py-1.5 text-xs font-medium text-gray-700 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
          Cumulative
        </button>
      </div>

      <%# Time range links %>
      <div class="inline-flex rounded-md shadow-sm">
        <% %w[6mo 12mo 24mo all].each_with_index do |range, i| %>
          <%
            active = @range == range
            rounded = case i
                      when 0 then "rounded-l-md"
                      when 3 then "-ml-px rounded-r-md"
                      else "-ml-px"
                      end
            classes = if active
                        "#{rounded} bg-indigo-600 px-3 py-1.5 text-xs font-medium text-white"
                      else
                        "#{rounded} bg-white px-3 py-1.5 text-xs font-medium text-gray-700 ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                      end
          %>
          <%= link_to range.upcase, admin_growth_path(range: range),
                class: classes,
                data: { turbo_action: "replace" } %>
        <% end %>
      </div>
    </div>
  </div>

  <div data-growth-chart-target="canvas" class="w-full" style="height: 300px;"></div>

  <% if @monthly_data.empty? %>
    <p class="mt-4 text-sm text-gray-500 text-center">No subscriber data for this period.</p>
  <% end %>
</div>

<%# Top Posts by Subscribers %>
<div class="mt-8 bg-white shadow rounded-lg p-6">
  <h2 class="text-lg font-medium text-gray-900 mb-4">Top Posts by Subscribers</h2>
  <% if @top_posts.any? %>
    <table class="min-w-full divide-y divide-gray-200">
      <thead>
        <tr>
          <th class="text-left text-xs font-medium text-gray-500 uppercase pb-2">Post</th>
          <th class="text-right text-xs font-medium text-gray-500 uppercase pb-2">Subscribers</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <% @top_posts.each do |post| %>
          <tr>
            <td class="py-2 text-sm text-gray-900">
              <%= link_to post.title, admin_post_dashboard_path(post), class: "hover:text-indigo-600" %>
            </td>
            <td class="py-2 text-sm text-gray-500 text-right"><%= post.subscribers_count %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-sm text-gray-500">No post-attributed subscribers yet. Subscribers who sign up from a post page will be tracked here going forward.</p>
  <% end %>
</div>
