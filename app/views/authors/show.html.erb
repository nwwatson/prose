<% content_for(:title, page_title(@identity.name)) %>

<% content_for(:head) do %>
  <% description = @identity.bio.present? ? strip_tags(@identity.bio_html).truncate(160) : t('authors.show.posts_by', name: @identity.name, site_name: site_name) %>
  <%= meta_description_tag(description) %>
  <%= open_graph_tags(title: "#{@identity.name} — #{site_name}", description: description, url: author_url(@identity, handle: @identity.handle)) %>
  <%= twitter_card_tags(title: "#{@identity.name} — #{site_name}", description: description) %>
  <%= canonical_tag(author_url(@identity, handle: @identity.handle)) %>
  <%= json_ld_for_author(@identity) %>
<% end %>

<%# Author header %>
<div class="border-b border-gray-300 dark:border-gray-700 pb-8 mb-8">
  <div class="flex items-start gap-5">
    <% if @identity.avatar.attached? %>
      <%= image_tag @identity.avatar.variant(resize_to_fill: [128, 128]),
            class: "h-24 w-24 rounded-full object-cover flex-shrink-0",
            alt: @identity.name %>
    <% else %>
      <div class="flex h-24 w-24 flex-shrink-0 items-center justify-center rounded-full bg-gray-200 dark:bg-gray-700">
        <span class="text-3xl font-bold text-gray-500 dark:text-gray-400"><%= @identity.name.first.upcase %></span>
      </div>
    <% end %>

    <div class="flex-1 min-w-0">
      <h1 class="font-display text-3xl font-bold"><%= @identity.name %></h1>

      <% if @identity.bio.present? %>
        <div class="mt-3 prose prose-sm dark:prose-invert max-w-none text-gray-600 dark:text-gray-400">
          <%= sanitize @identity.bio_html %>
        </div>
      <% end %>

      <div class="mt-3 flex flex-wrap items-center gap-3 text-sm text-gray-500 dark:text-gray-400">
        <span><%= t('authors.show.posts_published', count: @total_posts) %></span>

        <% if @identity.has_social_links? %>
          <span>&middot;</span>
          <div class="flex items-center gap-3">
            <% if @identity.website_url.present? %>
              <%= link_to @identity.website_url.sub(%r{\Ahttps?://}, ""), @identity.website_url,
                    class: "hover:text-ink-blue transition-colors", target: "_blank", rel: "noopener" %>
            <% end %>
            <% if @identity.twitter_url.present? %>
              <%= link_to "@#{@identity.twitter_handle}", @identity.twitter_url,
                    class: "hover:text-ink-blue transition-colors", target: "_blank", rel: "noopener" %>
            <% end %>
            <% if @identity.github_url.present? %>
              <%= link_to @identity.github_handle, @identity.github_url,
                    class: "hover:text-ink-blue transition-colors", target: "_blank", rel: "noopener" %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<%# Post archive %>
<% if @posts.any? %>
  <h2 class="font-display text-xl font-bold mb-6"><%= t('authors.show.posts_by_author', name: @identity.name) %></h2>

  <div class="space-y-8">
    <% @posts.each do |post| %>
      <article class="border-b border-gray-200 dark:border-gray-700 pb-8">
        <h3 class="font-display text-2xl font-bold">
          <%= link_to post.title, post_path(post, slug: post.slug),
                class: "text-charcoal hover:text-ink-blue transition-colors no-underline" %>
        </h3>
        <% if post.subtitle.present? %>
          <p class="mt-1 text-gray-600 dark:text-gray-400 font-subtitle"><%= post.subtitle %></p>
        <% end %>
        <div class="mt-2 flex items-center space-x-3 text-sm text-gray-500 dark:text-gray-400">
          <time datetime="<%= post.published_at.iso8601 %>"><%= post.published_at.strftime("%B %-d, %Y") %></time>
          <span>&middot;</span>
          <span><%= post.reading_time_minutes %> <%= t('shared.min_read') %></span>
          <% if post.category %>
            <span>&middot;</span>
            <%= link_to post.category.name, category_path(post.category, slug: post.category.slug),
                  class: "text-ink-blue hover:underline" %>
          <% end %>
        </div>
      </article>
    <% end %>
  </div>

  <% if @next_page %>
    <div class="mt-8 text-center">
      <%= link_to t('authors.show.load_more'), author_path(@identity, handle: @identity.handle, page: @next_page),
            class: "inline-block rounded-md bg-charcoal px-6 py-2 text-sm font-medium text-white hover:bg-gray-700 transition-colors" %>
    </div>
  <% end %>
<% else %>
  <div class="py-16 text-center">
    <p class="text-lg text-gray-500 dark:text-gray-400"><%= t('authors.show.no_posts') %></p>
  </div>
<% end %>
